import React, { useState, useEffect, useCallback } from 'react';
import { CHILDREN, ChildId, Transaction, TransactionType, StudyCategory, WithdrawCategory, AppSettings, DEFAULT_SETTINGS } from './types';
import { getEncouragementMessage } from './services/geminiService';
import { processInterest, calculateBalance, getStudyCategoryLabel, getWithdrawCategoryLabel } from './services/logicService';
import { StatsChart } from './components/StatsChart';
import { 
  PiggyBank, 
  Tv, 
  BookOpen, 
  History, 
  Trash2, 
  Trophy,
  Settings,
  UserCircle2,
  TrendingUp,
  PenTool,
  PlaySquare,
  X,
  Lock,
  LogOut,
  Gamepad2,
  MonitorPlay,
  Cloud,
  CheckCircle2,
  Save
} from 'lucide-react';

// --- Helper Components ---

const Modal = ({ 
  isOpen, 
  onClose, 
  title, 
  children 
}: { 
  isOpen: boolean; 
  onClose: () => void; 
  title: string; 
  children?: React.ReactNode 
}) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
        <div className="p-6 pb-2 flex justify-between items-center bg-white z-10">
          <h3 className="text-xl font-display font-bold text-slate-800">{title}</h3>
          <button onClick={onClose} className="p-2 -mr-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100">
            <X size={20} />
          </button>
        </div>
        <div className="p-6 pt-2 overflow-y-auto scrollbar-hide">
          {children}
        </div>
      </div>
    </div>
  );
};

const NumberKeypad = ({ onValueChange }: { onValueChange: (val: number) => void }) => {
  const [value, setValue] = useState<string>('');

  const handlePress = (num: number) => {
    if (value.length > 3) return; 
    const newValue = value + num.toString();
    setValue(newValue);
    onValueChange(parseInt(newValue, 10));
  };

  const handleBackspace = () => {
    const newValue = value.slice(0, -1);
    setValue(newValue);
    onValueChange(newValue ? parseInt(newValue, 10) : 0);
  };

  return (
    <div className="grid grid-cols-3 gap-2 mt-4">
      {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
        <button
          key={num}
          onClick={() => handlePress(num)}
          className="h-14 rounded-xl bg-slate-100 text-xl font-bold text-slate-700 active:bg-slate-200 active:scale-95 transition-all shadow-sm"
        >
          {num}
        </button>
      ))}
      <div className="col-span-1"></div>
      <button
        onClick={() => handlePress(0)}
        className="h-14 rounded-xl bg-slate-100 text-xl font-bold text-slate-700 active:bg-slate-200 active:scale-95 transition-all shadow-sm"
      >
        0
      </button>
      <button
        onClick={handleBackspace}
        className="h-14 rounded-xl bg-red-50 text-red-500 flex items-center justify-center active:bg-red-100 active:scale-95 transition-all shadow-sm"
      >
        <Trash2 size={24} />
      </button>
    </div>
  );
};

// --- Main App Component ---

const App = () => {
  const [activeChildId, setActiveChildId] = useState<ChildId>('seoa');
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [settings, setSettings] = useState<AppSettings>(DEFAULT_SETTINGS);
  
  // Modal States
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalType, setModalType] = useState<TransactionType>('deposit');
  const [step, setStep] = useState<'category-select' | 'amount-input'>('category-select');
  
  const [selectedStudyType, setSelectedStudyType] = useState<StudyCategory>('workbook');
  const [selectedWithdrawType, setSelectedWithdrawType] = useState<WithdrawCategory>('youtube_game');
  
  // Input States
  const [inputAmount, setInputAmount] = useState(0);
  const [isProcessing, setIsProcessing] = useState(false);
  const [aiToast, setAiToast] = useState<string | null>(null);
  const [syncStatus, setSyncStatus] = useState<'synced' | 'syncing'>('synced');

  // Parent/Auth States
  const [isParentMode, setIsParentMode] = useState(false);
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [showSettingsModal, setShowSettingsModal] = useState(false);

  const activeChild = CHILDREN[activeChildId];

  // --- Persistence & Initialization ---

  useEffect(() => {
    const savedTx = localStorage.getItem('timeBankTransactions');
    const savedSettings = localStorage.getItem('timeBankSettings');
    
    if (savedTx) {
      try {
        setTransactions(JSON.parse(savedTx));
      } catch (e) { console.error(e); }
    }
    
    if (savedSettings) {
      try {
        setSettings(JSON.parse(savedSettings));
      } catch (e) { console.error(e); }
    }
  }, []);

  useEffect(() => {
    // Simulate server sync delay
    setSyncStatus('syncing');
    const timer = setTimeout(() => {
        localStorage.setItem('timeBankTransactions', JSON.stringify(transactions));
        localStorage.setItem('timeBankSettings', JSON.stringify(settings));
        setSyncStatus('synced');
    }, 800);
    return () => clearTimeout(timer);
  }, [transactions, settings]);

  // --- Interest Check Logic ---
  useEffect(() => {
    if (transactions.length === 0) return;

    let newInterestTx: Transaction[] = [];
    
    (['seoa', 'seou'] as ChildId[]).forEach(id => {
       const interestTx = processInterest(transactions, id, settings);
       if (interestTx.length > 0) {
         newInterestTx = [...newInterestTx, ...interestTx];
       }
    });

    if (newInterestTx.length > 0) {
      setTransactions(prev => [...prev, ...newInterestTx]);
      setAiToast(`ì™€ìš°! TVë¥¼ ì°¸ì•„ì„œ ì´ìê°€ ${newInterestTx.length}ê±´ ìŒ“ì˜€ì–´ìš”! ğŸ‰`);
      setTimeout(() => setAiToast(null), 5000);
    }
  }, [transactions.length, settings]);

  // --- Handlers ---

  const currentBalance = calculateBalance(transactions, activeChildId);

  const handleTransaction = async () => {
    if (inputAmount <= 0) return;
    
    // Preliminary balance check
    if (modalType === 'withdraw' && inputAmount > currentBalance) {
      alert("ì €ì¶•ëœ ì‹œê°„ì´ ë¶€ì¡±í•´ìš”! ê³µë¶€ë¥¼ ë” í•´ì„œ ì‹œê°„ì„ ëª¨ì•„ë³´ì„¸ìš”. ğŸ’ª");
      return;
    }

    setIsProcessing(true);
    
    try {
      const aiMessage = await getEncouragementMessage(activeChild.name, inputAmount, modalType);
      
      let finalAmount = inputAmount;
      let note = '';
      let multiplier = 1;

      if (modalType === 'deposit') {
        multiplier = settings.multipliers[selectedStudyType];
        finalAmount = Math.floor(inputAmount * multiplier);
        note = getStudyCategoryLabel(selectedStudyType);
      } else if (modalType === 'withdraw') {
        multiplier = settings.withdrawMultipliers[selectedWithdrawType];
        finalAmount = Math.floor(inputAmount * multiplier);
        note = getWithdrawCategoryLabel(selectedWithdrawType);
        
        if (finalAmount > currentBalance) {
            alert("ì°¨ê° ë°°ìˆ˜ê°€ ì ìš©ë˜ì–´ ì‹œê°„ì´ ë¶€ì¡±í•´ìš”! (" + finalAmount + "ë¶„ í•„ìš”)");
            setIsProcessing(false);
            return;
        }
      }

      const newTransaction: Transaction = {
        id: Date.now().toString(),
        childId: activeChildId,
        type: modalType,
        amount: finalAmount,
        baseAmount: inputAmount,
        multiplier: multiplier,
        studyCategory: modalType === 'deposit' ? selectedStudyType : undefined,
        withdrawCategory: modalType === 'withdraw' ? selectedWithdrawType : undefined,
        timestamp: Date.now(),
        aiMessage: aiMessage,
        note: note
      };

      setTransactions(prev => [newTransaction, ...prev]);
      setAiToast(aiMessage);
      setTimeout(() => setAiToast(null), 5000);

    } catch (error) {
      console.error(error);
    } finally {
      setIsProcessing(false);
      setIsModalOpen(false);
      setInputAmount(0);
      setStep('category-select'); 
    }
  };

  const openModal = (type: TransactionType) => {
    setModalType(type);
    setInputAmount(0);
    setStep('category-select');
    setIsModalOpen(true);
  };

  const handleParentLogin = () => {
    setTimeout(() => {
      setIsParentMode(true);
      setShowLoginModal(false);
      setAiToast("ë¶€ëª¨ë‹˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
      setTimeout(() => setAiToast(null), 3000);
    }, 1000);
  };

  const formatTime = (minutes: number) => {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    if (h > 0) return `${h}ì‹œê°„ ${m}ë¶„`;
    return `${m}ë¶„`;
  };

  const getChildThemeClasses = (childId: ChildId) => {
    return childId === 'seoa' 
      ? { bg: 'bg-rose-500', text: 'text-rose-500', border: 'border-rose-200', soft: 'bg-rose-50' }
      : { bg: 'bg-sky-500', text: 'text-sky-500', border: 'border-sky-200', soft: 'bg-sky-50' };
  };

  const theme = getChildThemeClasses(activeChildId);

  // --- Sub-renderers ---

  const renderStudyCategorySelection = () => (
    <div className="grid grid-cols-1 gap-3">
      <p className="text-center text-slate-500 mb-2">ì–´ë–¤ ê³µë¶€ë¥¼ í–ˆë‚˜ìš”?</p>
      
      <button 
        onClick={() => { setSelectedStudyType('workbook'); setStep('amount-input'); }}
        className="flex items-center p-4 bg-green-50 border border-green-100 rounded-2xl hover:bg-green-100 transition-colors"
      >
        <div className="bg-white p-3 rounded-full shadow-sm mr-4">
          <PenTool className="text-green-600" />
        </div>
        <div className="text-left flex-1">
          <p className="font-bold text-slate-700 text-lg">ë¬¸ì œì§‘ í’€ê¸°</p>
          <p className="text-xs text-slate-500">2ë°°ë¡œ ì ë¦½í•´ì¤˜ìš”! (x{settings.multipliers.workbook})</p>
        </div>
        <div className="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-lg">x{settings.multipliers.workbook}</div>
      </button>

      <button 
        onClick={() => { setSelectedStudyType('book'); setStep('amount-input'); }}
        className="flex items-center p-4 bg-emerald-50 border border-emerald-100 rounded-2xl hover:bg-emerald-100 transition-colors"
      >
        <div className="bg-white p-3 rounded-full shadow-sm mr-4">
          <BookOpen className="text-emerald-600" />
        </div>
        <div className="text-left flex-1">
          <p className="font-bold text-slate-700 text-lg">ì±… ë³´ê¸°</p>
          <p className="text-xs text-slate-500">1.5ë°°ë¡œ ì ë¦½í•´ì¤˜ìš”! (x{settings.multipliers.book})</p>
        </div>
        <div className="bg-emerald-600 text-white text-xs font-bold px-2 py-1 rounded-lg">x{settings.multipliers.book}</div>
      </button>

      <button 
        onClick={() => { setSelectedStudyType('video'); setStep('amount-input'); }}
        className="flex items-center p-4 bg-teal-50 border border-teal-100 rounded-2xl hover:bg-teal-100 transition-colors"
      >
        <div className="bg-white p-3 rounded-full shadow-sm mr-4">
          <PlaySquare className="text-teal-600" />
        </div>
        <div className="text-left flex-1">
          <p className="font-bold text-slate-700 text-lg">ì˜ìƒ ê³µë¶€</p>
          <p className="text-xs text-slate-500">1.2ë°°ë¡œ ì ë¦½í•´ì¤˜ìš”! (x{settings.multipliers.video})</p>
        </div>
        <div className="bg-teal-600 text-white text-xs font-bold px-2 py-1 rounded-lg">x{settings.multipliers.video}</div>
      </button>
    </div>
  );

  const renderWithdrawCategorySelection = () => (
    <div className="grid grid-cols-1 gap-3">
      <p className="text-center text-slate-500 mb-2">ë¬´ì—‡ì„ ë³¼ ê±´ê°€ìš”?</p>
      
      <button 
        onClick={() => { setSelectedWithdrawType('youtube_game'); setStep('amount-input'); }}
        className="flex items-center p-4 bg-red-50 border border-red-100 rounded-2xl hover:bg-red-100 transition-colors"
      >
        <div className="bg-white p-3 rounded-full shadow-sm mr-4">
          <Gamepad2 className="text-red-500" />
        </div>
        <div className="text-left flex-1">
          <p className="font-bold text-slate-700 text-lg">ìœ íŠœë¸Œ/ê²Œì„</p>
          <p className="text-xs text-slate-500">ì‹œê°„ì´ ë¹¨ë¦¬ ì‚¬ë¼ì ¸ìš”! (x{settings.withdrawMultipliers.youtube_game} ì°¨ê°)</p>
        </div>
        <div className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-lg">x{settings.withdrawMultipliers.youtube_game}</div>
      </button>

      <button 
        onClick={() => { setSelectedWithdrawType('tv_watch'); setStep('amount-input'); }}
        className="flex items-center p-4 bg-orange-50 border border-orange-100 rounded-2xl hover:bg-orange-100 transition-colors"
      >
        <div className="bg-white p-3 rounded-full shadow-sm mr-4">
          <MonitorPlay className="text-orange-500" />
        </div>
        <div className="text-left flex-1">
          <p className="font-bold text-slate-700 text-lg">TV ì‹œì²­</p>
          <p className="text-xs text-slate-500">ì¼ë°˜ì ìœ¼ë¡œ ì°¨ê°ë¼ìš”. (x{settings.withdrawMultipliers.tv_watch} ì°¨ê°)</p>
        </div>
        <div className="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-lg">x{settings.withdrawMultipliers.tv_watch}</div>
      </button>
    </div>
  );

  const ParentDashboard = () => {
    const getStats = (childId: ChildId) => {
      const txs = transactions.filter(t => t.childId === childId);
      const earned = txs.filter(t => t.type === 'deposit' || t.type === 'interest').reduce((acc, t) => acc + t.amount, 0);
      const spent = txs.filter(t => t.type === 'withdraw').reduce((acc, t) => acc + t.amount, 0);
      const balance = earned - spent;
      return { earned, spent, balance };
    };

    return (
      <div className="p-4 space-y-6">
        <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
            <UserCircle2 className="text-indigo-500" />
            ë¶€ëª¨ë‹˜ ëŒ€ì‹œë³´ë“œ
            </h2>
            <div className="flex items-center gap-1.5 text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">
                {syncStatus === 'syncing' ? (
                    <>
                        <Cloud size={14} className="animate-pulse text-indigo-500" />
                        <span>ì €ì¥ ì¤‘...</span>
                    </>
                ) : (
                    <>
                        <CheckCircle2 size={14} className="text-green-500" />
                        <span>ì„œë²„ ë™ê¸°í™”ë¨</span>
                    </>
                )}
            </div>
        </div>
        
        {/* Seoa Stats */}
        <div className="bg-white rounded-3xl p-6 shadow-sm border border-rose-100 relative overflow-hidden">
          <div className="absolute top-0 right-0 w-24 h-24 bg-rose-50 rounded-full -mr-8 -mt-8 z-0"></div>
          <div className="relative z-10">
            <div className="flex items-center gap-3 mb-4">
              <span className="text-3xl">ğŸ‘§ğŸ»</span>
              <div>
                <h3 className="font-bold text-slate-800 text-lg">ìµœì„œì•„</h3>
                <span className="text-xs bg-rose-100 text-rose-600 px-2 py-0.5 rounded-full font-bold">Rose Theme</span>
              </div>
            </div>
            
            <div className="grid grid-cols-3 gap-2 text-center">
              <div className="p-2 bg-slate-50 rounded-xl">
                <p className="text-xs text-slate-400 mb-1">ì´ ì ë¦½</p>
                <p className="font-bold text-green-600 text-lg">{formatTime(getStats('seoa').earned)}</p>
              </div>
              <div className="p-2 bg-slate-50 rounded-xl">
                <p className="text-xs text-slate-400 mb-1">ì´ ì‚¬ìš©</p>
                <p className="font-bold text-red-500 text-lg">{formatTime(getStats('seoa').spent)}</p>
              </div>
              <div className="p-2 bg-rose-50 rounded-xl border border-rose-100">
                <p className="text-xs text-rose-400 mb-1">í˜„ì¬ ì”ì•¡</p>
                <p className="font-bold text-rose-600 text-lg">{formatTime(getStats('seoa').balance)}</p>
              </div>
            </div>
          </div>
        </div>

        {/* Seou Stats */}
        <div className="bg-white rounded-3xl p-6 shadow-sm border border-sky-100 relative overflow-hidden">
          <div className="absolute top-0 right-0 w-24 h-24 bg-sky-50 rounded-full -mr-8 -mt-8 z-0"></div>
          <div className="relative z-10">
            <div className="flex items-center gap-3 mb-4">
              <span className="text-3xl">ğŸ‘¦ğŸ»</span>
              <div>
                <h3 className="font-bold text-slate-800 text-lg">ìµœì„œìš°</h3>
                <span className="text-xs bg-sky-100 text-sky-600 px-2 py-0.5 rounded-full font-bold">Sky Theme</span>
              </div>
            </div>
            
            <div className="grid grid-cols-3 gap-2 text-center">
              <div className="p-2 bg-slate-50 rounded-xl">
                <p className="text-xs text-slate-400 mb-1">ì´ ì ë¦½</p>
                <p className="font-bold text-green-600 text-lg">{formatTime(getStats('seou').earned)}</p>
              </div>
              <div className="p-2 bg-slate-50 rounded-xl">
                <p className="text-xs text-slate-400 mb-1">ì´ ì‚¬ìš©</p>
                <p className="font-bold text-red-500 text-lg">{formatTime(getStats('seou').spent)}</p>
              </div>
              <div className="p-2 bg-sky-50 rounded-xl border border-sky-100">
                <p className="text-xs text-sky-400 mb-1">í˜„ì¬ ì”ì•¡</p>
                <p className="font-bold text-sky-600 text-lg">{formatTime(getStats('seou').balance)}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderChildView = () => (
    <div className="px-4 space-y-4">
      {/* Main Balance Card */}
      <div className={`relative overflow-hidden rounded-3xl p-6 text-white shadow-lg transition-colors duration-500 ${theme.bg}`}>
        <div className="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 rounded-full bg-white opacity-20 blur-2xl"></div>
        <div className="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 rounded-full bg-white opacity-20 blur-xl"></div>
        
        <div className="relative z-10 text-center">
          <p className="opacity-90 font-medium mb-1 flex items-center justify-center gap-1">
            {activeChild.name}ì˜ ëª¨ì€ ì‹œê°„
          </p>
          <div className="text-5xl font-display font-bold tracking-tight mb-2 drop-shadow-sm">
            {formatTime(currentBalance)}
          </div>
          <div className="inline-flex items-center gap-1.5 bg-white/20 px-3 py-1 rounded-full text-sm font-medium backdrop-blur-md border border-white/30">
            <Trophy size={14} className="text-yellow-300" />
            <span>í˜„ì¬ {currentBalance >= 120 ? 'ì•„ì£¼ í›Œë¥­í•´ìš”!' : 'ì¡°ê¸ˆ ë” ëª¨ì•„ë³¼ê¹Œìš”?'}</span>
          </div>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="grid grid-cols-2 gap-4">
        <button
          onClick={() => openModal('deposit')}
          className="group relative flex flex-col items-center justify-center p-5 bg-white rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition-all hover:border-green-200"
        >
          <div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center mb-3 group-hover:bg-green-200 transition-colors shadow-inner">
            <BookOpen className="text-green-600" size={26} />
          </div>
          <span className="font-bold text-slate-700 text-lg">ê³µë¶€ ê¸°ë¡í•˜ê¸°</span>
          <span className="text-xs text-slate-400 mt-1">ì €ê¸ˆí†µì— ì‹œê°„ ë„£ê¸°</span>
        </button>

        <button
          onClick={() => openModal('withdraw')}
          className="group relative flex flex-col items-center justify-center p-5 bg-white rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition-all hover:border-red-200"
        >
          <div className="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center mb-3 group-hover:bg-red-200 transition-colors shadow-inner">
            <Tv className="text-red-600" size={26} />
          </div>
          <span className="font-bold text-slate-700 text-lg">TV ë³´ê¸°</span>
          <span className="text-xs text-slate-400 mt-1">ì €ê¸ˆí†µì—ì„œ ì‹œê°„ ì“°ê¸°</span>
        </button>
      </div>

      {/* Charts */}
      <StatsChart transactions={transactions.filter(t => t.childId === activeChildId)} />

      {/* Recent History */}
      <div className="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 mb-8">
        <div className="flex items-center gap-2 mb-4 border-b border-slate-50 pb-2">
          <History size={18} className="text-slate-400" />
          <h3 className="font-bold text-slate-700">ìµœê·¼ í™œë™</h3>
        </div>
        
        <div className="space-y-3">
          {transactions.filter(t => t.childId === activeChildId).length === 0 ? (
            <div className="text-center py-8 text-slate-400 text-sm">
              ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. <br/> ì²« ê³µë¶€ ì‹œê°„ì„ ì €ì¶•í•´ë³´ì„¸ìš”!
            </div>
          ) : (
            transactions
              .filter(t => t.childId === activeChildId)
              .slice(0, 15)
              .map((t) => (
                <div key={t.id} className="flex items-center justify-between group py-2 border-b border-slate-50 last:border-0">
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 shadow-sm ${
                      t.type === 'deposit' 
                        ? 'bg-green-100 text-green-600' 
                        : t.type === 'interest' 
                          ? 'bg-yellow-100 text-yellow-600'
                          : 'bg-red-100 text-red-600'
                    }`}>
                      {t.type === 'deposit' ? <BookOpen size={18} /> : t.type === 'interest' ? <TrendingUp size={18} /> : <Tv size={18} />}
                    </div>
                    <div className="flex flex-col">
                      <div className="flex items-baseline gap-2">
                          <span className="font-bold text-slate-700 text-sm">
                          {t.type === 'deposit' 
                              ? 'ê³µë¶€' 
                              : t.type === 'interest' 
                              ? 'ì´ì' 
                              : 'TV'}
                          </span>
                          <span className="text-xs text-slate-500 font-medium">
                             {t.note || (t.type === 'deposit' ? 'ê¸°íƒ€ ê³µë¶€' : 'ê¸°íƒ€ ì‚¬ìš©')}
                          </span>
                      </div>
                      <span className="text-[10px] text-slate-400 mt-0.5">
                        {new Date(t.timestamp).toLocaleDateString('ko-KR', {month:'numeric', day:'numeric'})} {new Date(t.timestamp).toLocaleTimeString('ko-KR', {hour: '2-digit', minute:'2-digit'})}
                      </span>
                    </div>
                  </div>
                  
                  <div className="text-right">
                      <div className={`font-display font-bold text-lg ${
                      t.type === 'withdraw' ? 'text-red-500' : 'text-green-500'
                      }`}>
                      {t.type === 'withdraw' ? '-' : '+'}{t.amount}ë¶„
                      </div>
                      {t.baseAmount && t.baseAmount !== t.amount && (
                          <div className="text-[10px] text-slate-400 line-through">
                              {t.baseAmount}ë¶„
                          </div>
                      )}
                  </div>
                </div>
              ))
          )}
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 pb-20 max-w-md mx-auto relative shadow-2xl overflow-hidden font-sans">
      
      {/* Header */}
      <header className="px-6 py-5 bg-white border-b border-slate-100 flex items-center justify-between sticky top-0 z-10 shadow-sm">
        <div>
          <h1 className="text-2xl font-display font-bold text-slate-800 flex items-center gap-2">
            <PiggyBank className="text-yellow-500" fill="currentColor" />
            ì‹œê°„ ì €ê¸ˆí†µ
          </h1>
          <p className="text-slate-500 text-[10px] mt-0.5">
             {isParentMode ? 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ëª¨ë‹˜ ëª¨ë“œ ì‹¤í–‰ ì¤‘' : 'ê³µë¶€í•˜ë©´ TV ì‹œê°„ì´ ìŒ“ì—¬ìš”!'}
          </p>
        </div>
        <div>
          {isParentMode ? (
             <div className="flex gap-2">
               <button 
                onClick={() => setShowSettingsModal(true)}
                className="p-2 bg-slate-100 rounded-full text-slate-600 hover:bg-slate-200"
               >
                 <Settings size={20} />
               </button>
               <button 
                onClick={() => { setIsParentMode(false); setAiToast("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤."); setTimeout(() => setAiToast(null), 2000); }}
                className="p-2 bg-slate-100 rounded-full text-slate-600 hover:bg-slate-200"
               >
                 <LogOut size={20} />
               </button>
             </div>
          ) : (
            <button 
              onClick={() => setShowLoginModal(true)}
              className="flex items-center gap-1 px-3 py-1.5 bg-slate-100 rounded-full text-xs font-bold text-slate-500 hover:bg-slate-200 transition-colors"
            >
              <UserCircle2 size={16} />
              ë¶€ëª¨ë‹˜
            </button>
          )}
        </div>
      </header>

      {/* Child Selector - Only show in Child Mode */}
      {!isParentMode && (
        <div className="p-4 flex gap-3 overflow-x-auto no-scrollbar">
          {Object.values(CHILDREN).map((child) => (
            <button
              key={child.id}
              onClick={() => setActiveChildId(child.id)}
              className={`flex-1 flex items-center justify-center gap-3 p-3 rounded-2xl transition-all border-2 shadow-sm ${
                activeChildId === child.id
                  ? `border-${child.themeColor}-500 bg-${child.themeColor}-50 scale-[1.02]`
                  : 'border-white bg-white opacity-70 grayscale-[0.5]'
              }`}
            >
              <span className="text-2xl filter-none">{child.avatarEmoji}</span>
              <span className={`font-bold ${activeChildId === child.id ? `text-${child.themeColor}-700` : 'text-slate-600'}`}>
                {child.name}
              </span>
            </button>
          ))}
        </div>
      )}

      {/* Main Content */}
      {isParentMode ? <ParentDashboard /> : renderChildView()}

      {/* Main Action Modal */}
      <Modal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        title={modalType === 'deposit' ? 'ğŸ“š ê³µë¶€ ì‹œê°„ ê¸°ë¡' : 'ğŸ“º TV ì‹œì²­ ì‹œê°„'}
      >
        {step === 'category-select' ? (
           modalType === 'deposit' ? renderStudyCategorySelection() : renderWithdrawCategorySelection()
        ) : (
          <div className="flex flex-col items-center">
             <div className="mb-4 text-center">
               <span className={`text-sm px-3 py-1 rounded-full font-bold ${
                 modalType === 'deposit' 
                    ? 'bg-green-50 text-green-600'
                    : 'bg-red-50 text-red-600'
               }`}>
                  {modalType === 'deposit' 
                    ? `${getStudyCategoryLabel(selectedStudyType)} (x${settings.multipliers[selectedStudyType]})`
                    : `${getWithdrawCategoryLabel(selectedWithdrawType)} (x${settings.withdrawMultipliers[selectedWithdrawType]})`
                  }
               </span>
             </div>

            <div className="flex items-baseline gap-2 mb-2">
              <span className="text-5xl font-bold text-slate-800 font-display">
                  {inputAmount > 0 ? inputAmount : 0}
              </span>
              <span className="text-xl text-slate-500 font-medium">ë¶„</span>
            </div>
            
            {/* Dynamic Calculation Preview */}
            {inputAmount > 0 && (
                <div className="mb-4 text-slate-500 font-medium animate-pulse text-sm">
                    = ì‹¤ì œ 
                    <span className={`font-bold mx-1 ${modalType === 'deposit' ? 'text-green-600' : 'text-red-600'}`}>
                        {Math.floor(inputAmount * (modalType === 'deposit' ? settings.multipliers[selectedStudyType] : settings.withdrawMultipliers[selectedWithdrawType]))}ë¶„
                    </span> 
                    {modalType === 'deposit' ? 'ì ë¦½' : 'ì°¨ê°'}
                </div>
            )}
            
            <p className="text-sm text-slate-400 mb-6 text-center">
              {modalType === 'deposit' 
                ? `${activeChild.name}, ì˜¤ëŠ˜ ì–¼ë§ˆë‚˜ ì§‘ì¤‘í–ˆë‚˜ìš”?` 
                : `${activeChild.name}, ì–¼ë§ˆë‚˜ ë³¼ ê±´ê°€ìš”?`}
            </p>

            <div className="w-full">
              <button
                disabled={inputAmount === 0 || isProcessing}
                onClick={handleTransaction}
                className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-md transition-all active:scale-95 flex items-center justify-center gap-2 ${
                  inputAmount === 0 
                    ? 'bg-slate-300 cursor-not-allowed' 
                    : modalType === 'deposit' 
                      ? 'bg-green-500 hover:bg-green-600 shadow-green-200' 
                      : 'bg-red-500 hover:bg-red-600 shadow-red-200'
                }`}
              >
                {isProcessing ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    ì²˜ë¦¬ì¤‘...
                  </>
                ) : (
                  'í™•ì¸'
                )}
              </button>
              <NumberKeypad onValueChange={setInputAmount} />
            </div>
          </div>
        )}
      </Modal>

      {/* Login Modal */}
      <Modal 
        isOpen={showLoginModal}
        onClose={() => setShowLoginModal(false)}
        title="ë¶€ëª¨ë‹˜ ë¡œê·¸ì¸"
      >
        <div className="text-center py-4">
          <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
            <Lock className="text-blue-500" size={32} />
          </div>
          <p className="text-slate-600 mb-6">ì„¤ì • ë³€ê²½ ë° ìë…€ ê´€ë¦¬ë¥¼ ìœ„í•´<br/>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
          
          <button
            onClick={handleParentLogin}
            className="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition-colors shadow-sm"
          >
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
          </button>
          <p className="text-xs text-slate-400 mt-4">* ì‹¤ì œ ì¸ì¦ì€ ì„œë²„ê°€ í•„ìš”í•˜ë¯€ë¡œ<br/>ë°ëª¨ì—ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
        </div>
      </Modal>

      {/* Settings Modal */}
      <Modal
        isOpen={showSettingsModal}
        onClose={() => setShowSettingsModal(false)}
        title="ì„¤ì • ê´€ë¦¬"
      >
        <div className="space-y-6">
          {/* Deposit Multipliers */}
          <div>
            <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
              <TrendingUp size={18} className="text-green-500" />
              ê³µë¶€ ì ë¦½ ë°°ìˆ˜
            </h4>
            <div className="grid grid-cols-1 gap-3 bg-slate-50 p-4 rounded-xl">
              <div className="flex items-center justify-between gap-4">
                <span className="text-slate-600 text-sm font-medium">ë¬¸ì œì§‘ í’€ê¸°</span>
                <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">ë°°</span>
                    <input 
                    type="number" step="0.1" min="1.0"
                    value={settings.multipliers.workbook}
                    onChange={(e) => setSettings({...settings, multipliers: {...settings.multipliers, workbook: parseFloat(e.target.value)}})}
                    className="w-20 p-2 rounded-lg border border-slate-200 text-center font-bold text-green-600 focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400"
                    />
                </div>
              </div>
              <div className="flex items-center justify-between gap-4">
                <span className="text-slate-600 text-sm font-medium">ì±… ë³´ê¸°</span>
                <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">ë°°</span>
                    <input 
                    type="number" step="0.1" min="1.0"
                    value={settings.multipliers.book}
                    onChange={(e) => setSettings({...settings, multipliers: {...settings.multipliers, book: parseFloat(e.target.value)}})}
                    className="w-20 p-2 rounded-lg border border-slate-200 text-center font-bold text-emerald-600 focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400"
                    />
                </div>
              </div>
              <div className="flex items-center justify-between gap-4">
                <span className="text-slate-600 text-sm font-medium">ì˜ìƒ ê³µë¶€</span>
                <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">ë°°</span>
                    <input 
                    type="number" step="0.1" min="1.0"
                    value={settings.multipliers.video}
                    onChange={(e) => setSettings({...settings, multipliers: {...settings.multipliers, video: parseFloat(e.target.value)}})}
                    className="w-20 p-2 rounded-lg border border-slate-200 text-center font-bold text-teal-600 focus:outline-none focus:border-teal-400 focus:ring-1 focus:ring-teal-400"
                    />
                </div>
              </div>
            </div>
          </div>

          {/* Withdraw Multipliers */}
          <div>
            <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
              <Tv size={18} className="text-red-500" />
              ì‚¬ìš© ì°¨ê° ë°°ìˆ˜
            </h4>
            <div className="grid grid-cols-1 gap-3 bg-slate-50 p-4 rounded-xl">
              <div className="flex items-center justify-between gap-4">
                <span className="text-slate-600 text-sm font-medium">ìœ íŠœë¸Œ/ê²Œì„</span>
                <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">ë°°</span>
                    <input 
                    type="number" step="0.1" min="1.0"
                    value={settings.withdrawMultipliers.youtube_game}
                    onChange={(e) => setSettings({...settings, withdrawMultipliers: {...settings.withdrawMultipliers, youtube_game: parseFloat(e.target.value)}})}
                    className="w-20 p-2 rounded-lg border border-slate-200 text-center font-bold text-red-600 focus:outline-none focus:border-red-400 focus:ring-1 focus:ring-red-400"
                    />
                </div>
              </div>
              <div className="flex items-center justify-between gap-4">
                <span className="text-slate-600 text-sm font-medium">TV ì‹œì²­</span>
                <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">ë°°</span>
                    <input 
                    type="number" step="0.1" min="1.0"
                    value={settings.withdrawMultipliers.tv_watch}
                    onChange={(e) => setSettings({...settings, withdrawMultipliers: {...settings.withdrawMultipliers, tv_watch: parseFloat(e.target.value)}})}
                    className="w-20 p-2 rounded-lg border border-slate-200 text-center font-bold text-orange-600 focus:outline-none focus:border-orange-400 focus:ring-1 focus:ring-orange-400"
                    />
                </div>
              </div>
            </div>
          </div>

          {/* Interest Settings */}
          <div>
             <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
              <PiggyBank size={18} className="text-yellow-500" />
              ì´ì ì‹œìŠ¤í…œ ì„¤ì •
            </h4>
             <div className="space-y-3 bg-slate-50 p-4 rounded-xl">
               <div className="flex items-center justify-between">
                  <span className="text-slate-600 text-sm font-medium">ì¼ì¼ ì´ììœ¨</span>
                  <div className="flex items-center gap-2">
                      <input 
                        type="number" step="0.01" min="0" max="1"
                        value={settings.interestRate}
                        onChange={(e) => setSettings({...settings, interestRate: parseFloat(e.target.value)})}
                        className="w-20 p-2 rounded-lg border border-slate-200 text-center font-bold text-yellow-600 focus:outline-none focus:border-yellow-400"
                      />
                  </div>
               </div>
               <div className="flex justify-between text-xs text-slate-400 px-1">
                   <span>í˜„ì¬: {Math.round(settings.interestRate * 100)}%</span>
               </div>
               
               <div className="border-t border-slate-200 my-2"></div>

               <div className="flex items-center justify-between">
                  <span className="text-slate-600 text-sm font-medium">TV ë¯¸ì‹œì²­ ê¸°ì¤€</span>
                  <div className="flex items-center gap-2">
                      <span className="text-xs text-slate-400">ì‹œê°„</span>
                      <input 
                        type="number" step="1" min="1"
                        value={settings.interestThresholdHours}
                        onChange={(e) => setSettings({...settings, interestThresholdHours: parseInt(e.target.value)})}
                        className="w-20 p-2 rounded-lg border border-slate-200 text-center font-bold text-slate-600 focus:outline-none focus:border-slate-400"
                      />
                  </div>
               </div>
             </div>
          </div>
          
          <div className="pt-2">
             <button 
               onClick={() => {
                   setSettings(DEFAULT_SETTINGS);
                   alert("ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
               }}
               className="w-full py-3 text-sm text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors flex items-center justify-center gap-2"
             >
                 <Trash2 size={16} />
                 ì„¤ì • ì´ˆê¸°í™”
             </button>
          </div>
        </div>
      </Modal>

      {/* AI Toast Notification */}
      {aiToast && (
        <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[60] w-[90%] max-w-sm px-0 animate-in slide-in-from-top-4 fade-in duration-300">
          <div className="bg-slate-800/95 backdrop-blur-md text-white px-5 py-4 rounded-2xl shadow-2xl flex items-start gap-3 border border-slate-700">
             <div className="text-2xl animate-bounce">ğŸ¤–</div>
             <div>
               <p className="font-bold text-yellow-300 text-sm mb-0.5">AI ê°€ë””ì–¸</p>
               <p className="text-sm leading-relaxed">{aiToast}</p>
             </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
